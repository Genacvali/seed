# 🚀 Migration Guide: v2 → v3\n\n## Summary of Changes\n\nSEED v3 represents a complete architectural redesign with the following key improvements:\n\n### ✨ New Architecture\n- **Single Binary**: `seed-agent.py` replaces separate `app.py` + `worker.py`\n- **Unified Config**: `seed.yaml` replaces multiple config files\n- **Consolidated Plugins**: `plugins.py` contains all monitoring logic\n- **Docker First**: Complete containerization with external config mounting\n\n### 📁 File Structure Comparison\n\n**v2 Structure:**\n```\nv2/\n├── app.py                    # FastAPI web server\n├── worker.py                 # Alert processing worker  \n├── core/                     # Core modules\n├── plugins/                  # Individual plugin files\n├── configs/\n│   ├── routing.yaml         # Alert routing\n│   └── hosts.yaml           # Host configuration\n└── fetchers/                 # Data fetchers\n```\n\n**v3 Structure:**\n```\nv3/\n├── seed-agent.py            # 🎯 Single executable (server + worker)\n├── seed.yaml                # 📋 Unified configuration\n├── plugins.py               # 🔌 All plugins in one file\n├── docker-compose.yml       # 🐳 Production environment\n├── Dockerfile               # 🏗️ Container definition\n├── Makefile                 # 🛠️ Development commands\n└── core/                    # 📚 Refactored core modules\n```\n\n## 🔧 Migration Steps\n\n### 1. Configuration Migration\n\n**Old way (v2):**\n- `configs/routing.yaml` - alert routing rules\n- `configs/hosts.yaml` - host-specific settings\n- Environment variables for infrastructure\n\n**New way (v3):**\n```yaml\n# seed.yaml - everything in one place\nsystem:\n  agent: { bind_host: \"0.0.0.0\", bind_port: 8080 }\n  alerts: { ttl_seconds: 30, max_retries: 3 }\n\ninfrastructure:\n  rabbitmq: { host: \"rabbitmq\", port: 5672, username: \"seed\" }\n  redis: { host: \"redis\", port: 6379 }\n\nhosts:\n  groups:\n    mongo-prod:\n      hosts: [\"mongo-prod-01\", \"mongo-prod-02\"]\n      overrides: { mongo_host: \"mongo-prod-01\" }\n\nrouting:\n  alerts:\n    DiskSpaceHigh:\n      plugin: \"host_inventory\"\n      payload: { paths: [\"/\"], priority: \"high\" }\n```\n\n### 2. Plugin Migration\n\n**Old way (v2):**\n```python\n# plugins/host_inventory.py\ndef run(host, labels, annotations, payload):\n    # plugin logic\n    return message\n```\n\n**New way (v3):**\n```python\n# plugins.py - all plugins in one file\nasync def host_inventory(host, labels, annotations, payload):\n    # async plugin logic with better error handling\n    return message\n    \n# Plugin registry\nPLUGINS = {\n    \"host_inventory\": host_inventory,\n    \"mongo_hot\": mongo_hot,\n}\n```\n\n### 3. Deployment Migration\n\n**Old way (v2):**\n```bash\n# Manual setup\npython app.py &              # Start web server\npython worker.py &           # Start worker\n# Manual RabbitMQ/Redis setup\n```\n\n**New way (v3):**\n```bash\n# Docker-based deployment\nmake up                      # Start everything\n# OR\ndocker-compose up -d        # Direct Docker Compose\n```\n\n### 4. Development Workflow\n\n**Old way (v2):**\n- Edit multiple files\n- Restart services manually\n- Manual dependency management\n\n**New way (v3):**\n```bash\nmake dev                     # Start development environment\nmake test-plugins           # Test individual plugins\nmake reload-config          # Hot reload configuration\nmake logs                   # View unified logs\n```\n\n## 🔄 Runtime Migration\n\n### Step-by-Step Migration\n\n1. **Backup existing setup:**\n   ```bash\n   cp -r v2/ v2-backup/\n   ```\n\n2. **Create unified config:**\n   ```bash\n   cd v3/\n   # Edit seed.yaml with your current settings\n   ```\n\n3. **Migrate plugins:**\n   ```bash\n   # Consolidate your v2 plugins into v3/plugins.py\n   # Follow the async pattern shown in the file\n   ```\n\n4. **Test the new setup:**\n   ```bash\n   make validate-config        # Validate configuration\n   make dev                    # Start development environment\n   make test-plugins          # Test all plugins\n   ```\n\n5. **Deploy:**\n   ```bash\n   make build                 # Build production images\n   make up                    # Deploy production environment\n   ```\n\n## 🚨 Breaking Changes\n\n### Configuration\n- Configuration files are now consolidated into `seed.yaml`\n- Environment variable names may have changed\n- Host grouping syntax is different\n\n### Plugins\n- Plugins must now be async functions (use `async def`)\n- All plugins consolidated into single `plugins.py` file\n- Plugin registration via `PLUGINS` dictionary\n- Error handling is now centralized\n\n### API\n- Same REST API endpoints (`/alert`, `/health`, `/stats`)\n- Additional endpoints: `/config/reload`\n- Response formats remain compatible\n\n### Infrastructure\n- RabbitMQ and Redis now run in containers\n- Network configuration may need adjustment for existing monitoring\n\n## 🎯 Benefits of v3\n\n### Operational\n- **Simplified deployment** - single command startup\n- **Better monitoring** - unified logging and metrics\n- **Hot reload** - configuration changes without restart\n- **Health checks** - automatic container restart on failure\n\n### Development\n- **Faster iteration** - development environment setup in seconds\n- **Plugin testing** - individual plugin testing commands\n- **Debugging** - structured logging and error handling\n\n### Production\n- **Resource efficiency** - optimized container resource usage\n- **Scalability** - easy horizontal scaling of workers\n- **Security** - non-root containers, isolated networks\n- **Backup** - external configuration makes backup simple\n\n## 🆘 Troubleshooting\n\n### Common Issues\n\n**Config file not found:**\n```bash\n# Make sure seed.yaml is in the right location\nls -la v3/seed.yaml\n```\n\n**Plugins not loading:**\n```bash\n# Test plugins individually\ndocker-compose exec seed-agent python plugins.py test host_inventory\n```\n\n**Service connectivity:**\n```bash\n# Check service health\nmake health-all\ndocker-compose ps\n```\n\n**Port conflicts:**\n```bash\n# Check if ports are already in use\nnetstat -tlnp | grep :8080\n# Edit docker-compose.yml to change ports if needed\n```\n\n### Getting Help\n\n1. **Check logs:**\n   ```bash\n   make logs\n   make logs-agent\n   ```\n\n2. **Validate setup:**\n   ```bash\n   make health\n   make stats\n   ```\n\n3. **Reset environment:**\n   ```bash\n   make clean\n   make dev\n   ```\n\n## 📚 Additional Resources\n\n- **README.md** - Complete documentation\n- **seed.yaml** - Configuration reference with comments\n- **plugins.py** - Plugin examples and patterns\n- **Makefile** - All available commands\n\n---\n\n**Ready to migrate?** Start with `cd v3 && make dev` and you'll be up and running in minutes! 🚀