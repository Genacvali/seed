# ====================================
# SEED v2 - MongoDB COLLSCAN Monitoring
# ====================================

# === SYSTEM METRICS ===
[[inputs.cpu]]
  percpu = false
  totalcpu = true

[[inputs.mem]]
[[inputs.disk]]
  mount_points = ["/", "/data"]

[[inputs.system]]

# === MONGODB METRICS ===
[[inputs.mongodb]]
  servers = ["mongodb://zabbix:zabbix@centos-s-1vcpu-512mb-10gb-fra1-01:27017/?connect=direct"]
  gather_perdb_stats = true
  gather_col_stats = false

# === COLLSCAN DETECTION ===
[[inputs.exec]]
  commands = ['''
    bash -c '
    tail -n 1000 /data/logs/mongod.log | grep COLLSCAN | tail -n 10 | while read line; do
      ns=$(echo "$line" | jq -r ".attr.ns // empty")
      duration=$(echo "$line" | jq -r ".attr.durationMillis // 0")
      docs_examined=$(echo "$line" | jq -r ".attr.docsExamined // 0")
      keys_examined=$(echo "$line" | jq -r ".attr.keysExamined // 0")
      nreturned=$(echo "$line" | jq -r ".attr.nreturned // 0")
      timestamp=$(echo "$line" | jq -r ".t.\"\$date\"" | head -c 19 | tr T " ")
      
      if [[ -n "$ns" && "$duration" != "null" ]]; then
        echo "collscan,namespace=$ns,alert_type=collscan_detected,severity=warning durationMillis=${duration}i,docsExamined=${docs_examined}i,keysExamined=${keys_examined}i,nreturned=${nreturned}i"
      fi
    done
    '
  ''']
  timeout = "10s"
  interval = "30s"
  data_format = "influx"
  name_suffix = "_collscan_events"

# === COLLSCAN COUNTER ===
[[inputs.exec]]
  commands = ["bash -c 'grep -c COLLSCAN /data/logs/mongod.log 2>/dev/null || echo 0'"]
  timeout = "5s"
  interval = "60s"
  name_suffix = "_collscan_count"
  data_format = "value"
  data_type = "integer"
  [inputs.exec.tags]
    metric_type = "collscan_counter"

# === PROCESSORS ===
[[processors.enum]]
  namepass = ["*collscan*"]
  [[processors.enum.mapping]]
    field = "docsExamined"
    dest = "severity_level"
    default = "low"
    [processors.enum.mapping.value_mappings]
      "1000" = "medium"
      "10000" = "high"
      "100000" = "critical"

# === OUTPUTS ===
[[outputs.prometheus_client]]
  listen = ":9216"
  metric_version = 2
  namepass = ["*collscan*", "mongodb*"]

[[outputs.file]]
  files = ["/var/log/mongodb-collscan-alerts.log"]
  namepass = ["*collscan*"]
  data_format = "json"