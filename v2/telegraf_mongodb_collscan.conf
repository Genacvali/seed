# ====================================
# SEED v2 - MongoDB COLLSCAN Monitoring
# ====================================

# === SYSTEM METRICS ===
[[inputs.cpu]]
  percpu = false
  totalcpu = true

[[inputs.mem]]
[[inputs.disk]]
  mount_points = ["/", "/data"]

[[inputs.system]]

# === MONGODB METRICS ===
[[inputs.mongodb]]
  servers = ["mongodb://zabbix:zabbix@centos-s-1vcpu-512mb-10gb-fra1-01:27017/?connect=direct"]
  gather_perdb_stats = true
  gather_col_stats = false

# === COLLSCAN DETECTION ===
[[inputs.tail]]
  files = ["/var/log/mongodb/mongod.log"]
  from_beginning = false
  watch_method = "inotify"
  name_suffix = "_collscan"
  data_format = "grok"
  grok_patterns = [
    '%{TIMESTAMP_ISO8601:timestamp}.*"planSummary":.*"COLLSCAN".*"durationMillis":%{NUMBER:duration_ms:int}.*"ns":"%{DATA:namespace}".*"docsExamined":%{NUMBER:docs_examined:int}.*'
  ]
  [inputs.tail.tags]
    alert_type = "collscan_detected"
    severity = "warning"

# === COLLSCAN COUNTER ===
[[inputs.exec]]
  commands = ["bash -c 'grep -c COLLSCAN /var/log/mongodb/mongod.log 2>/dev/null || echo 0'"]
  timeout = "5s"
  interval = "60s"
  name_suffix = "_collscan_count"
  data_format = "value"
  data_type = "integer"
  [inputs.exec.tags]
    metric_type = "collscan_counter"

# === PROCESSORS ===
[[processors.converter]]
  namepass = ["*collscan*"]
  [processors.converter.fields]
    integer = ["duration_ms", "docs_examined"]

[[processors.enum]]
  namepass = ["*collscan*"]
  [[processors.enum.mapping]]
    field = "docs_examined"
    dest = "severity_level"
    default = "low"
    [processors.enum.mapping.value_mappings]
      "1000" = "medium"
      "10000" = "high"
      "100000" = "critical"

# === OUTPUTS ===
[[outputs.prometheus_client]]
  listen = ":9216"
  metric_version = 2
  namepass = ["*collscan*", "mongodb*"]

[[outputs.file]]
  files = ["/var/log/mongodb-collscan-alerts.log"]
  namepass = ["*collscan*"]
  data_format = "json"